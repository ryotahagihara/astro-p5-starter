---
import Layout from "@/layouts/Layout.astro";
import { Code } from "astro:components";
import fs from "fs";

export function getStaticPaths() {
  const sketches = import.meta.glob("/src/sketches/**/*.ts");

  return Object.keys(sketches)
    .filter((path) => !path.split("/").some((part) => part.startsWith("_")))
    .map((path) => {
      const slug = path.replace("/src/sketches/", "").replace(/\.ts$/, "");
      return { params: { slug } };
    });
}

const { slug } = Astro.params;
const code = fs.readFileSync(`src/sketches/${slug}.ts`, "utf-8");
---

<Layout title={slug}>
  <h2 class="break-all">{slug}.ts</h2>
  <div id="sketch-container" data-slug={slug}></div>
  <Code code={code} lang="typescript" />
</Layout>

<script>
  const container = document.getElementById("sketch-container");
  const slug = container?.dataset.slug;

  if (slug) {
    const modules = import.meta.glob("/src/sketches/**/*.ts");
    const modulePath = `/src/sketches/${slug}.ts`;

    if (modules[modulePath]) {
      modules[modulePath]();
    }
  }
</script>

<style is:global>
  canvas {
    display: block;
    margin: 1.5rem auto;
    max-width: 100%;
    height: auto !important;
    border: 1px solid #e5e7eb;
  }
</style>

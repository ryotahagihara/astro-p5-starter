---
import Layout from "@/layouts/Layout.astro";
import SketchList from "@/components/SketchList.astro";

interface TreeNode {
  name: string;
  path?: string;
  children?: TreeNode[];
}

function buildSketchTree(paths: string[]): TreeNode[] {
  const root: TreeNode[] = [];

  paths.forEach((path) => {
    const parts = path.split("/");
    let currentList = root;

    parts.forEach((part, index) => {
      let targetNode = currentList.find((node) => node.name === part);

      if (!targetNode) {
        const isFile = index === parts.length - 1;
        const newNode: TreeNode = {
          name: part,
          path: isFile ? path.replace(/\.ts$/, "") : undefined,
          children: isFile ? undefined : [],
        };
        currentList.push(newNode);
        targetNode = newNode;
      }

      if (targetNode.children) {
        currentList = targetNode.children;
      }
    });
  });

  return root;
}

function sortSketchTree(nodes: TreeNode[]) {
  nodes.sort((a, b) => {
    const aIsFolder = !!a.children;
    const bIsFolder = !!b.children;

    if (aIsFolder && !bIsFolder) return -1;
    if (!aIsFolder && bIsFolder) return 1;

    return a.name.localeCompare(b.name);
  });

  nodes.forEach((node) => {
    if (node.children) {
      sortSketchTree(node.children);
    }
  });
}

const sketches = import.meta.glob("/src/sketches/**/*.ts");
const paths = Object.keys(sketches)
  .filter((path) => !path.split("/").some((part) => part.startsWith("_")))
  .map((path) => path.replace("/src/sketches/", ""))
  .sort();

const tree = buildSketchTree(paths);
sortSketchTree(tree);
---

<Layout>
  <section>
    <div class="not-prose my-2 flex flex-wrap items-center gap-2">
      <img
        src="https://img.shields.io/badge/p5%20js-ED225D?style=for-the-badge&logo=p5dotjs&logoColor=white"
        alt="p5.js"
        class="h-6"
      />
      <img
        src="https://img.shields.io/badge/Astro-0C1222?style=for-the-badge&logo=astro&logoColor=FDFDFE"
        alt="Astro"
        class="h-6"
      />
      <img
        src="https://img.shields.io/badge/TypeScript-007ACC?style=for-the-badge&logo=typescript&logoColor=white"
        alt="TypeScript"
        class="h-6"
      />
      <img
        src="https://img.shields.io/badge/Tailwind_CSS-38B2AC?style=for-the-badge&logo=tailwind-css&logoColor=white"
        alt="Tailwind CSS"
        class="h-6"
      />
      <img
        src="https://img.shields.io/badge/Cloudflare-F38020?style=for-the-badge&logo=Cloudflare&logoColor=white"
        alt="Cloudflare"
        class="h-6"
      />
      <img
        src="https://img.shields.io/badge/prettier-1A2C34?style=for-the-badge&logo=prettier&logoColor=F7BA3E"
        alt="Prettier"
        class="h-6"
      />
      <img
        src="https://img.shields.io/badge/eslint-3A33D1?style=for-the-badge&logo=eslint&logoColor=white"
        alt="ESLint"
        class="h-6"
      />
      <img
        src="https://img.shields.io/badge/MIT-green?style=for-the-badge"
        alt="MIT"
        class="h-6"
      />
    </div>
  </section>
  <section>
    <h2>Minimal Setup for p5.js Development</h2>
    <p>
      This is a starter kit for developing p5.js sketches with TypeScript. Built
      on Astro v5, it eliminates the initial environment setup, allowing you to
      focus immediately on creative coding. Sketches are portable to other
      creative coding platforms.
    </p>
    <div class="not-prose my-4 flex flex-wrap gap-2">
      <a
        href="https://github.com/new?template_name=astro-p5-starter&template_owner=ryotahagihara"
        target="_blank"
        rel="noopener noreferrer"
      >
        <img
          src="https://img.shields.io/badge/use_this_template-197935?style=for-the-badge&logo=github&logoColor=white"
          alt="Use this template"
          class="h-8"
        />
      </a>
      <a
        href="https://github.com/ryotahagihara/astro-p5-starter"
        target="_blank"
        rel="noopener noreferrer"
      >
        <img
          src="https://img.shields.io/badge/view_on_github-1f2328?style=for-the-badge&logo=github&logoColor=white"
          alt="View on GitHub"
          class="h-8"
        />
      </a>
    </div>
  </section>
  <section>
    <h2>Sketches</h2>
    <nav class="prose-ul:list-none prose-li:list-none">
      <SketchList tree={tree} />
    </nav>
  </section>
</Layout>
